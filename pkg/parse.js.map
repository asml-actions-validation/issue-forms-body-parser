{"version":3,"file":"parse.js","sources":["../src/parsers/date.js","../src/parsers/time.js","../src/parsers/index.js","../src/parsers/list.js","../src/parse.js","../src/parsers/images.js","../src/parsers/links.js","../src/parsers/duration.js"],"sourcesContent":["'use strict'\n\nimport { parse, isMatch } from 'date-fns'\nimport { zonedTimeToUtc } from 'date-fns-tz'\n\nconst loc = 'UTC'\nconst commonDateFormats = [\n  'yyyy-MM-dd',\n  'dd/MM/yyyy',\n  'dd/MM/yy',\n  'dd-MM-yyyy',\n  'dd-MM-yy',\n  'dd.MM.yyyy',\n  'dd.MM.yy'\n]\n\nexport default function parseDate(text) {\n  const match = commonDateFormats.map((format) => {\n    return isMatch(text, format)\n  })\n  if (match.indexOf(true) > -1) {\n    const date = zonedTimeToUtc(\n      parse(text, commonDateFormats[match.indexOf(true)], new Date()),\n      loc\n    ).toJSON()\n    return date.split('T')[0]\n  } else {\n    return null\n  }\n}\n","'use strict'\n\nimport { parse, isMatch } from 'date-fns'\nimport { zonedTimeToUtc, formatInTimeZone } from 'date-fns-tz'\n\nconst loc = 'UTC'\nconst commonTimeFormats = [\n  'HH:mm',\n  'HH.mm',\n  'hh:mm aaa',\n  'hh:mm a..aa',\n  'hh:mm aaaa'\n]\n\nexport default function parseTime(text) {\n  const match = commonTimeFormats.map((format) => {\n    return isMatch(text, format)\n  })\n  if (match.indexOf(true) > -1) {\n    const time = zonedTimeToUtc(\n      parse(text, commonTimeFormats[match.indexOf(true)], new Date()),\n      loc\n    )\n    return formatInTimeZone(time, loc, 'HH:mm')\n  } else {\n    return null\n  }\n}\n","'use strict'\n\nimport date from './date.js'\nimport time from './time.js'\nimport duration from './duration.js'\nimport list from './list.js'\nimport images from './images.js'\nimport links from './links.js'\n\nexport const parseDate = date\nexport const parseTime = time\nexport const parseDuration = duration\nexport const parseList = list\nexport const parseImages = images\nexport const parseLinks = links\n","'use strict'\n\nexport default function parseList(list) {\n  return list.children\n    .map((item) => {\n      const listItem = {}\n      if (item.type === 'list') {\n        return parseList(list)\n      } else if (item.type === 'listItem') {\n        listItem.checked = item.checked\n        return item.children\n          .map((child) => {\n            if (child.type === 'paragraph') {\n              listItem.text = child.children\n                .map((c) => {\n                  if (c.type === 'link') {\n                    listItem.link = c.url\n                    return `[${c.children[0].value}](${c.url})`\n                  } else {\n                    return c.value\n                  }\n                })\n                .filter((x) => !!x)\n                .join('')\n              return listItem\n            }\n          })\n          .filter((x) => !!x)\n      }\n    })\n    .filter((x) => !!x)\n}\n","'use strict'\n\nimport { unified } from 'unified'\nimport remarkParse from 'remark-parse'\nimport remarkGfm from 'remark-gfm'\nimport slugify from '@sindresorhus/slugify'\nimport remarkStringify from 'remark-stringify'\nimport stripFinalNewline from 'strip-final-newline'\nimport createDebug from 'debug'\nconst debug = createDebug('body-parser')\n\nimport {\n  parseDate,\n  parseTime,\n  parseDuration,\n  parseList,\n  parseImages,\n  parseLinks\n} from './parsers/index.js'\n\nexport default async function parseMD(body) {\n  debug('parseMD()')\n  const tokens = await unified().use(remarkParse).use(remarkGfm).parse(body)\n  if (!tokens) {\n    return []\n  }\n\n  const structuredResponse = {}\n  let currentHeading = null\n\n  for (const token of tokens.children) {\n    const text = await unified()\n      .use(remarkGfm)\n      .use(remarkStringify)\n      .stringify(token)\n    let cleanText = stripFinalNewline(text)\n\n    // remove `\\\\_`\n    if (cleanText.indexOf('\\\\_') > -1) {\n      cleanText = cleanText.replace(/\\\\_/g, '_')\n    }\n\n    // issue forms uses h3 as a heading\n    if (token.type === 'heading') {\n      currentHeading = slugify(token.children[0].value)\n      structuredResponse[currentHeading] = {\n        title: token.children[0].value,\n        heading: token.depth,\n        content: []\n      }\n    } else if (token.type === 'paragraph' && currentHeading) {\n      const obj = structuredResponse[currentHeading]\n\n      const date = parseDate(cleanText)\n      const images = parseImages(token.children)\n      const links = parseLinks(token.children)\n      const time = parseTime(cleanText)\n      const duration = parseDuration(cleanText)\n\n      if (date) {\n        obj.date = date\n      }\n\n      if (time) {\n        obj.time = time\n      }\n\n      if (duration) {\n        obj.duration = duration\n      }\n\n      if (links && links.length > 0) {\n        obj.links = links\n      }\n\n      if (images && images.length > 0) {\n        obj.images = images\n      }\n\n      obj.content.push(cleanText)\n    } else if (token.type === 'list') {\n      const obj = structuredResponse[currentHeading]\n      obj.text = cleanText\n      obj.list = parseList(token).flat()\n    } else if (token.type === 'html') {\n      const obj = structuredResponse[currentHeading]\n      obj.content.push(token.html)\n    } else if (token.type === 'code') {\n      const obj = structuredResponse[currentHeading]\n      obj.lang = token.lang\n      obj.text = cleanText\n    } else {\n      debug('unhandled token type')\n      debug(token)\n    }\n  }\n\n  for (const key in structuredResponse) {\n    const token = structuredResponse[key]\n    const content = token.content.filter(Boolean)\n    if (content && content.length > 0) {\n      if (content.length === 1) {\n        token.text = content[0]\n      }\n      token.text = content.join('\\n\\n')\n    }\n    token.content = content\n  }\n\n  return structuredResponse\n}\n","'use strict'\n\nexport default function parseImage(props) {\n  return props\n    .filter((p) => p.type === 'image')\n    .map((p) => {\n      return {\n        src: p.url,\n        alt: p.alt\n      }\n    })\n}\n","'use strict'\n\nexport default function parseLinks(props) {\n  return props\n    .filter((p) => p.type === 'link')\n    .map((p) => {\n      return {\n        src: p.url,\n        alt: p.children[0].value\n      }\n    })\n}\n","'use strict'\n\nexport default function parseDuration(text) {\n  let matched = false\n  const duration = {\n    hours: 0,\n    minutes: 0\n  }\n\n  const hoursAndMinutes = new RegExp(/([0-9]+)h([0-9]+)m/)\n  const hours = new RegExp(/([0-9]+)h/)\n\n  if (text.match(hoursAndMinutes)) {\n    matched = true\n    const [, h, m] = text.match(hoursAndMinutes)\n    duration.hours = parseInt(h)\n    duration.minutes = parseInt(m)\n  } else if (text.match(hours)) {\n    matched = true\n    const [, h] = text.match(hours)\n    duration.hours = parseInt(h)\n    duration.minutes = 0\n  }\n\n  if (matched) {\n    return duration\n  } else {\n    return null\n  }\n}\n"],"names":["commonDateFormats","commonTimeFormats","parseList","list","children","map","item","listItem","type","checked","child","text","c","link","url","value","filter","x","join","_settle","pact","state","s","_Pact","o","bind","v","then","observer","parseMD","body","_iterator","_step","token","cleanText","obj","date","images","links","time","duration","key","content","Promise","debug","resolve","unified","use","remarkParse","remarkGfm","parse","tokens","_temp2","structuredResponse","Boolean","length","currentHeading","_createForOfIteratorHelperLoose","_temp","test","update","stage","shouldContinue","_isSettledPact","result","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","_for","done","remarkStringify","stringify","_unified$use$use$stri","match","stripFinalNewline","indexOf","replace","slugify","title","heading","depth","format","isMatch","zonedTimeToUtc","Date","toJSON","split","p","src","alt","formatInTimeZone","parseTime","matched","hours","minutes","hoursAndMinutes","RegExp","_text$match","m","parseInt","_text$match2","parseDuration","push","flat","html","lang","e","prototype","onFulfilled","onRejected","this","callback","_this","thenable","createDebug"],"mappings":"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"}